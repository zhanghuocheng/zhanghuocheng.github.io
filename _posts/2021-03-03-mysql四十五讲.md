---
layout: page

---

*  目录
{:toc}

### mysql 45 讲

#### 1 基础架构-一条sql查询语句是如何执行的

###### 1.1 整体架构

![image-20211119075001474](/Users/romeo/Library/Application Support/typora-user-images/image-20211119075001474.png)

###### 1.2 连接器

```
1 连接命令：mysql -h$ip -P$port -u$user -p //建议密码不要跟在-p后面 ，产生密码泄漏？
	密码错误 -Access denied for user
2 show processlist 查看连接；连接默认时间是8小时，wait_timeout 参数控制
	连接断开的错误
3 连接失效 再查询 报错 Lost connection to MySQL server during query -->解决办法--->再建立连接
4 长连接使用过多-->内存涨得快---原因-->执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放----解决办法--->
	4.1 定期断开，遇到大查询 断开连接 重连
	4.2 mysql version>=5.7 mysql_reset_connection 重制连接
```



###### 1.2 查询缓存

```
1 查询缓存 缓存的存储 key(sql) value (ret)  一般不开启-->查询缓存往往弊大于利 -->表更新，缓存失效
2 使用场景，静态表，几乎不更新的
3 设置  query_cache_type  DEMAND 默认sql不查缓存
4 8.0废弃查询缓存

```

####### 1.3  分析器

```
1 词法分析 关键字拼写对不对
2 语法分析 关键字排列是否正确
```

###### 1.4 优化器

```
1 选择索引决定权 
2 表的关联顺序  select * from t1 join t2 where t1.a=t2.b
```

###### 1.5 执行器 select * from table where id >90

```
1 权限验证
2 打开表，根据表的定义，执行引擎提供的接口

如果表没有索引的执行过程
	1 调用引擎接口取表的第一行。判断id是否大于90 
	2 调用引擎接口取表的下一行。判断id是否大于90 
	3 返回满足上面的结果集
	
慢查sql rows_examined 这个字段表示一次查询扫描了多少行 注意 ：在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此引擎扫描行数跟rows_examined并不是完全相同的
```





#### 2 日志系统--一条sql 更新语句是如何执行的

```
mysql可以恢复到半个月内 任意一秒的状态
```

2.1  redo log  (重做日志) -InnoDB独有 引擎层

```
WAL技术，WAL的全称是Write-Ahead Logging 先写进日志 再进磁盘
crash-safe  就是在关机之前 把 中间缓存的日志全部写到文件
```

2.2 bin log  (归档日志)- server层



2.3 redo log  &&bin log区别

```
1 redo log是InnoDB引擎特有的；binlog是MySQL的Server层实现的，所有引擎都可以使用。

2 redo log是物理日志，记录的是“在某个数据页上做了什么修改”；binlog是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID=2这一行的c字段加1 ”。

3 redo log是循环写的，空间固定会用完；binlog是可以追加写入的。“追加写”是指binlog文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。
```





